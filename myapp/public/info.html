<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sms</title>
    <link rel="stylesheet" href="./stylesheets/info.css">
</head>

<body>
    <div class="container">
        <div class="stu-list">
            <table>
                <thead>
                    <tr>
                        <th>id</th>
                        <th>name</th>
                        <th>age</th>
                        <th>gender</th>
                        <th>className</th>
                        <th>handle</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="pagination">
                <input class="first-page" type="button" value="首页">
                <input class="prev-page" type="button" value="前一页"">
                <span class=" cur-page">1</span>/<span class="total-page">5</span>
                <input class="next-page" type="button" value="后一页">
                <input class="last-page" type="button" value="尾页">
                <select class="page-items" name="" id="">
                    <option>3</option>
                    <option selected>5</option>
                    <option>7</option>
                    <option>10</option>
                    <option>15</option>
                    <option>30</option>
                </select>
            </div>
        </div>
        <div class="handle">
            <div class="add-form">
                <form action="" name="add-form">
                    <p>
                        name:<input type="text" name="name">
                    </p>
                    <p>
                        age:<input type="text" name="age">
                    </p>
                    <p>
                        gender:<input type="text" name="gender">
                    </p>
                    <p>
                        className:<input type="text" name="className">
                    </p>
                    <p>
                        <input type="button" class="add-btn" value="add">
                    </p>
                </form>
            </div>

            <div class="update-form">
                <form action="" name="update-form">
                    <p>
                        id:<input type="text" name="_id" readonly>
                    </p>
                    <p>
                        name:<input type="text" name="name">
                    </p>
                    <p>
                        age:<input type="text" name="age">
                    </p>
                    <p>
                        gender:<input type="text" name="gender">
                    </p>
                    <p>
                        className:<input type="text" name="className">
                    </p>
                    <p>
                        <input type="button" class="update-btn" value="update">
                    </p>
                </form>
            </div>
        </div>
    </div>
    <script src="./javascripts/axios.js"></script>
    <script src="./javascripts/jquery-3.3.1.js"></script>
    <script>
        // $.ajaxSettings.beforeSend = function (xhr, request) {
        //     const user_token = window.localStorage.getItem('user_token');
        //      xhr.setRequestHeader('Authorization', `Bearer ${user_token}`);
        // }


        function useToken() {
            window.axiosIns = axios.create({
                baseURL: 'http://localhost:4444',
                timeout: 1000,
                headers: { "Authorization": `Bearer ${localStorage.user_token}` }
            });
        };
        useToken();
        window.onstorage = function ({ key, newValue }) {
            if (key === "user_token") {
                useToken();
            }
        }
        class Info {
            pager = {
                rows: null,//具体数据
                page: 1,//当前页码
                limit: 5,//页面大小
                total: null,//总页面数
                count: null//总数据条数
            }
            constructor() {
                this.init();
            }
            init() {
                this.renderStuList();
                this.handler();
            }
            handler() {
                const that = this;
                $(".pagination").on({
                    click() {
                        const className = this.className;
                        switch (className) {
                            case "first-page":
                                {
                                    that.pager.page = 1;
                                    that.renderStuList();
                                }
                                break;
                            case "prev-page":
                                {
                                    if (that.pager.page - 1 > 0) {
                                        that.pager.page--;
                                        that.renderStuList();
                                    }

                                }
                                break;
                            case "next-page":
                                {
                                    if (that.pager.page + 1 <= that.pager.total) {
                                        that.pager.page++;
                                        that.renderStuList();
                                    }
                                }
                                break;
                            case "last-page":
                                {
                                    that.pager.page = that.pager.total;
                                    that.renderStuList();
                                }
                                break;
                        }

                    },
                    input() {
                        if (this.className === "page-items") {
                            that.pager.limit = ~~this.value;
                            that.renderStuList();
                        }

                    }
                }, "input,select");
                $(".stu-list table>tbody").on("click", ".modify,.delete", function () {
                    switch (this.value) {
                        case "modify":
                            {
                                const _id = this.dataset._id;
                                const stu = that.pager.rows.filter(stu => stu._id === _id)[0];
                                const updateForm = $(".update-form>form")[0];
                                updateForm._id.value = stu._id;
                                updateForm.name.value = stu.name;
                                updateForm.age.value = stu.age;
                                updateForm.gender.value = stu.gender;
                                updateForm.className.value = stu.className;
                            }
                            break;
                        case "delete":
                            {
                                const _id = this.dataset._id;
                                axiosIns.delete("/api/students/" + _id)
                                    .then(function ({ data }) {
                                        const { isDelete } = data;
                                        if (isDelete) {
                                            alert("delete success!");
                                            const { page, limit, total, count } = that.pager;
                                            if (page > Math.ceil(((count - 1) / limit))) {
                                                that.pager.page = total - 1;
                                            }
                                            that.renderStuList();
                                        } else {
                                            alert("delete failed!");
                                        }
                                    })
                                    .catch(function (error) {
                                        console.log(error);
                                    });
                            }
                            break;
                    }
                });
                $(".update-form .update-btn").click(function () {
                    axiosIns.put(
                        "/api/students/" + $(".update-form>form")[0]._id.value,
                        $(".update-form>form").serialize()
                    )
                        .then(function ({ data }) {
                            const { isUpdate } = data;
                            if (isUpdate) {
                                alert("update success!");
                                that.renderStuList();
                            } else {
                                alert("update failed!")
                            }
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                });
                $(".add-form .add-btn").click(function () {
                    axiosIns.post(
                        "/api/students/",
                        $(".add-form>form").serialize()
                    )
                        .then(function ({ data }) {
                            const { isAdd } = data;
                            if (isAdd) {
                                alert("add success!");
                                const { limit, count } = that.pager;
                                that.pager.page = Math.ceil(((count + 1) / limit));
                                that.renderStuList();
                            } else {
                                alert("add failed!")
                            }
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                });
            }
            renderStuList() {
                const that = this;
                // $.ajax("http://localhost:3000/students/?callback=?", {
                axiosIns.get(
                    "/api/students/",
                    {
                        params: { limit: that.pager.limit, page: that.pager.page }
                    }
                )
                    .then(function ({ data }) {
                        Object.assign(that.pager, data);
                        if (data.rows) {
                            const template = that.pager.rows.map(stu => `
                            <tr>
                                <td>${stu._id.slice(-4)}</td>
                                <td>${stu.name}</td>
                                <td>${stu.age}</td>
                                <td>${stu.gender}</td>
                                <td>${stu.className}</td>
                                <td>
                                    <input data-_id="${stu._id}" type="button" value="modify" class="modify">
                                    <input data-_id="${stu._id}" type="button" value="delete" class="delete">
                                </td>
                            </tr>
                            `).join("");
                            $(".stu-list table>tbody").html(template);
                            $(".cur-page").html(that.pager.page);
                            $(".total-page").html(that.pager.total);
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
        }



        var page = new Info();
    </script>

</body>

</html>